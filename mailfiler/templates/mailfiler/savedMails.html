<!-- Copyright (c) Microsoft Corporation.
     Licensed under the MIT License. -->

<!-- <CalendarSnippet> -->
{% extends "mailfiler/layout.html" %}
{% block content %}
<h1>Saved Mails on S3 Bucket</h1>
<!-- <a href="/calendar/new" class="btn btn-light btn-sm mb-3">New event</a> -->
{% csrf_token %}
<table class="table">
  <thead>
    <tr>
      <th scope="col">Id</th>
      <th scope="col">Subject</th>
      <th scope="col">BodyPreview</th>
      <th scope="col">From</th>
      <th scope="col">ReceivedDateTime</th>
      <th scope="col">Attachments</th>
      <th scope="col">Url</th>
    </tr>
  </thead>
  <tbody>
    {% if mails %}
      {% for mail in mails %}
        <tr>
          <td>{{ mail.immutableId }}</td>
          <td>{{ mail.subject }}</td>
          <td>{{ mail.bodyPreview }}</td>
          <td>{{ mail.sender }}</td>
          <td>{{ mail.receivedDateTime }}</td>
          {% if mail.attachments|length > 0 %}
          <td><input onclick="showAttaches('{{mail.immutableId}}')" type='button' class="secondary" value="See"></td>
          {% else %}
          <td></td>
          {% endif %}
          <td><a href="{{ mail.url }}">click here</a></td>
        </tr>
      {% endfor %}
    {% endif %}
  </tbody>
</table>
<dialog id="favDialog">
  <table id="attachTable">
  </table>
  <button id="cancel" type="reset">Cancel</button>
</dialog>
{% endblock %}
{% block script %}
<script>
  let contextMails = JSON.parse('{{ jsonMails|escapejs }}')
  console.log(contextMails)
  var cancelButton = document.getElementById('cancel')
  var favDialog = document.getElementById('favDialog')

  // show the modal dialog
  function showAttaches(id){
    let mail = contextMails.filter(function(mail){return id == mail.immutableId})
    let attaches = mail[0].attachments
    $('#attachTable').text("")
    $('#attachTable').append('<tr><th>id</th><th>name</th><th>contentType</th><th>size</th><th>URL</th></tr>')
    attaches.forEach(attach => {
      $('#attachTable').append('<tr><td>' + attach.immutableId.substring(0, 10) + '</td><td>' + attach.name  + '</td><td>' + attach.contentType + '</td><td>' + attach.size + '</td><td><a href="' + attach.url + '">Click here</a></td></tr>')
    })

    favDialog.showModal()
  }

  // Form cancel button closes the dialog box
  cancelButton.addEventListener('click', function() {
    favDialog.close()
  });
</script>
{% endblock %}
<!-- </CalendarSnippet> -->
