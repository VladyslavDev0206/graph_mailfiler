<!-- Copyright (c) Microsoft Corporation.
     Licensed under the MIT License. -->

<!-- <CalendarSnippet> -->
{% extends "mailfiler/layout.html" %}
{% block content %}
<h1>Saved Mails on S3 Bucket</h1>
<!-- <a href="/calendar/new" class="btn btn-light btn-sm mb-3">New event</a> -->
{% csrf_token %}
<table class="table">
  <thead>
    <tr>
      <!-- <th scope="col">Id</th> -->
      <th scope="col">Title</th>
      <th scope="col">Url</th>
    </tr>
  </thead>
  <tbody>
    {% if mails %}
      {% for mail in mails %}
        <tr>
          <!-- <td>{{ mail.id }}</td> -->
          <td>{{ mail.title }}</td>
          <td><a href="{{ mail.document }}">click here</a></td>
        </tr>
      {% endfor %}
    {% endif %}
  </tbody>
</table>
{% endblock %}
{% block script %}
<script>
  function saveMails(){
    let fields = ['msg', 'sender', 'isRead', 'receivedDate'];
    let mails = [];
    $( "tr" ).each(function( index ) {
      if(index > 0){
        let mail = {}
        $( this ).children('td').each(function(index){
          let value = $(this).text()
          mail[fields[index]] = value;
        })
        mails.push(mail)
      }
    });
    
    mails = JSON.stringify(mails)
    title = $('p[name="email"]').text()
    title = (title.split('@')[0]).slice(0, 5)
    title += '_' + formatDate(new Date(Date.now()))
    console.log(title)

    $.post("mail/save",
    {
      mails : mails,
      title : title
    },
    function(data, status){
      if(data == 'success')
        alert('saved successufuly')
    });
  }
  // add csrf token
  let csrfField = $('input[name="csrfmiddlewaretoken"]')[0]
  $.ajaxSetup({
      headers: {
          'X-CSRFToken': $(csrfField).val()
      }
  });
  // Format date function
  function formatDate(date) {
    var d = date,
    month = '' + (d.getMonth() + 1),
    day = '' + d.getDate(),
    year = '' + d.getFullYear();

    if (month.length < 2) 
        month = '0' + month;
    if (day.length < 2) 
        day = '0' + day;

    hour = '' + d.getHours(),
    minute = '' + d.getMinutes()
    second = '' + d.getSeconds()
    if (hour.length < 2) 
        hour = '0' + hour;
    if (minute.length < 2) 
        minute = '0' + minute;
    if (second.length < 2) 
        second = '0' + second;

    return [year.slice(2,4), month, day].join('') + '_' + [hour, minute, second].join('');
  }
</script>
{% endblock %}
<!-- </CalendarSnippet> -->
