<!-- Copyright (c) Microsoft Corporation.
     Licensed under the MIT License. -->

<!-- <CalendarSnippet> -->
{% extends "mailfiler/layout.html" %}
{% block content %}
<a href="{% url 'saveMail' %}" class="btn btn-primary">Saved Mails</a>
<button class="btn btn-success float-right" onclick="saveMails()">Save</button>
<!-- <a href="/calendar/new" class="btn btn-light btn-sm mb-3">New event</a> -->
{% csrf_token %}
<table class="table">
  <thead>
    <tr>
      <th scope="col" style="display:none">Id</th>
      <th scope="col">Subject</th>
      <th scope="col" style="display:none">body</th>
      <th scope="col">Body</th>
      <th scope="col">From</th>
      <th scope="col">Read</th>
      <th scope="col">Received</th>
    </tr>
  </thead>
  <tbody>
    {% if mails %}
      {% for mail in mails %}
        <tr>
          <td style="display:none">{{ mail.id }}</td>
          <td>{{ mail.subject }}</td>
          <td style="display:none">{{ mail.body }}</td>
          <td>{{ mail.bodyPreview }}...</td>
          <td>{{ mail.from.emailAddress.name }}</td>
          <td>{{ mail.isRead }}</td>
          <td>{{ mail.receivedDateTime }}</td>
        </tr>
      {% endfor %}
    {% endif %}
  </tbody>
</table>
{% endblock %}
{% block script %}
<script>
  function saveMails(){
    let fields = ['immutableId', 'subject', 'body', 'bodyPreview', 'sender', 'isRead', 'receivedDateTime'];
    let mails = [];
    $( "tr" ).each(function( index ) {
      if(index > 0){
        let mail = {}
        $( this ).children('td').each(function(index){
          let value = $(this).text()
          if(fields[index] == 'receivedDateTime'){
            mail[fields[index]] = formatDate(new Date(value))
            console.log(mail[fields[index]])
          }
          else  mail[fields[index]] = value
        })
        mails.push(mail)
      }
    });
    
    mails = JSON.stringify(mails)
    title = $('p[name="email"]').text()
    title = (title.split('@')[0]).slice(0, 5)
    title += '_' + formatDate(new Date(Date.now()))

    $.post("{% url 'saveMail' %}",
    {
      mails : mails,
      title : title
    },
    function(data, status){
      alert('Mail Saved Successfuly')
    });
  }
  // add csrf token
  let csrfField = $('input[name="csrfmiddlewaretoken"]')[0]
  $.ajaxSetup({
      headers: {
          'X-CSRFToken': $(csrfField).val()
      }
  });
  function formatDate(date) {
    var d = date,
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear();

    if (month.length < 2) 
        month = '0' + month;
    if (day.length < 2) 
        day = '0' + day;

    return [year, month, day].join('-');
  }
  // Format date function
  function formatDate1(date) {
    var d = date,
    month = '' + (d.getMonth() + 1),
    day = '' + d.getDate(),
    year = '' + d.getFullYear();

    if (month.length < 2) 
        month = '0' + month;
    if (day.length < 2) 
        day = '0' + day;

    hour = '' + d.getHours(),
    minute = '' + d.getMinutes()
    second = '' + d.getSeconds()
    if (hour.length < 2) 
        hour = '0' + hour;
    if (minute.length < 2) 
        minute = '0' + minute;
    if (second.length < 2) 
        second = '0' + second;

    return [year.slice(2,4), month, day].join('') + '_' + [hour, minute, second].join('');
  }
</script>
{% endblock %}
<!-- </CalendarSnippet> -->
